# rebuild-full-project.yml
# Description: Workflow automatisÃ© pour rebuild full project
# Date: 2025-07-25
# Version: 1.0

name: Rebuild Full Project


# Permissions pour la sÃ©curitÃ©
permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read
  security-events: read

on:
  workflow_dispatch:

jobs:
  rebuild:
    runs-
# Permissions pour la sÃ©curitÃ©
permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read
  security-events: read

on: ubuntu-latest
    
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_VERSION: '18'
        PYTHON_VERSION: '3.11'

    steps:
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Fallback : Si ZIP lite existe, on dÃ©compresse
      - name: Restore from ZIP Lite (if available)
        id: unzip
        run: |
          if [ -f "./tools/lite-backup.zip" ]; then
            unzip -o ./tools/lite-backup.zip -d ./
            echo "files_restored=1" >> $GITHUB_ENV
          else
            echo "ZIP Lite not found. Will fallback on static sources."
            echo "files_restored=0" >> $GITHUB_ENV
          fi

      # 2. Restaure quelques fichiers critiques (README, scripts) si manquants
      - name: Restore critical files (README, scripts)
        if: env.files_restored != '1'
        run: |
          # Exemple README.md
          cat <<'EOF' > README.md
          # com.tuya.zigbee
          (insÃ¨re ici le contenu complet que tu veux avoir par dÃ©faut)
          EOF
          # Exemple repair_project.ps1
          cat <<'EOF' > repair_project.ps1
          #!/usr/bin/env pwsh
          Write-Output "Script auto-restore PowerShell."
          # Met ici le code complet ou minimal viable
          EOF

      # 3. (Optionnel) TÃ©lÃ©charge les fichiers manquants via RAW, GIST, etc.
      - name: Download missing files from external (fallback)
        if: env.files_restored != '1'
        run: |
          # Ex: RÃ©cupÃ©rer un manifest ou driver depuis GitHub Raw
          curl -fsSL https://raw.githubusercontent.com/dlnraja/com.tuya.zigbee/master/.github/workflows/bench-ia.yml -o .github/workflows/bench-ia.yml || true
          # Ajoute dâ€™autres wget/curl pour dâ€™autres fichiers critiques si besoin

      # 4. GÃ©nÃ¨re un workflow de rÃ©paration auto en cas de push failed
      - name: Generate repair workflow (push fail-safe)
        run: |
          cat <<'EOF' > .github/workflows/repair-on-push-fail.yml
          name: Repair on Push Fail
          
# Permissions pour la sÃ©curitÃ©
permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read
  security-events: read

on:
            workflow_run:
              workflows: ["Rebuild Full Project"]
              types:
                - completed
          jobs:
            repair:
              if: ${{ github.event.workflow_run.conclusion == 'failure' }}
              runs-
# Permissions pour la sÃ©curitÃ©
permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read
  security-events: read

on: ubuntu-latest
              
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_VERSION: '18'
        PYTHON_VERSION: '3.11'

    steps:
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

                - name: Checkout
                  uses: actions/checkout@v4
                - name: Log issue
                  run: echo "Push failed. Triggered auto-repair at $(date -u)." >> push-repair.log
                - name: Push repair log
                  run: |
                    git config --global user.name "repair-bot"
                    git config --global user.email "bot@dlnraja.com"
                    git add push-repair.log
                    git commit -m "chore: auto-repair after push fail"
                    git push
          EOF

      # 5. Commit et push
      - name: Commit and push all restored/generated files
        run: |
          git config --global user.name "dlraja-bot"
          git config --global user.email "bot@dlnraja.com"
          git add .
          git commit -m "restore: rebuilt all project files via workflow (auto, fallback: $files_restored)" || echo "No changes to commit"
          git push

      # 6. CrÃ©er le log dÃ©taillÃ© de lâ€™opÃ©ration
      - name: Create detailed restore log
        run: |
          echo "Restore operation completed at $(date -u)" > restore-operation.log
          git add restore-operation.log
          git commit -m "docs: restore operation log" || true
          git push

