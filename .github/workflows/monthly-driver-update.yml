name: 🗓️ Monthly Driver Update

on:
  schedule:
    # Run on the first day of every month at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no changes will be committed)'
        required: false
        default: 'false'
        type: boolean

env:
  DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry-run == 'true' || 'false' }}
  NODE_VERSION: '18'

jobs:
  update-drivers:
    name: 🔄 Update Drivers
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: 🛑 Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
        with:
          access_token: ${{ github.token }}

      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ⎔ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🔍 Full Repository Analysis
        run: node scripts/analyze-repo.js

      - name: 📥 Multi-source Driver Enrichment
        run: node scripts/enrich-drivers.js

      - name: ⭐ Update Reliability Scores
        run: node scripts/update-scores.js

      - name: 📝 Generate Multilingual Documentation
        run: node scripts/generate-docs.js

      - name: 🗂️ Create Lite Version
        if: env.DRY_RUN == 'false'
        run: node scripts/create-lite-version.js

      - name: ✅ Run Validation Tests
        run: npm test

      - name: 📝 Create Pull Request
        if: env.DRY_RUN == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: monthly driver update [skip ci]
            
            FR: Mise à jour mensuelle des drivers
          title: "🔧 Monthly Driver Updates"
          body: |
            ## 📦 Driver Updates
            
            This PR includes:
            - Full repository analysis
            - Driver enrichment from multiple sources
            - Reliability scoring updates
            - Multilingual documentation
            - Lite version creation
            
            🤖 Auto-generated by GitHub Actions
          branch: chore/monthly-update-${{ github.run_id }}
          delete-branch: true

      - name: 📤 Create Issue if No Updates
        if: env.DRY_RUN == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,driver-update'
            });
            
            const hasOpenIssue = issues.some(issue => 
              issue.title.includes('No Driver Updates Found')
            );
            
            if (!hasOpenIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '✅ No Driver Updates Found',
                body: 'The monthly driver update check completed successfully, but no updates were found.',
                labels: ['automated', 'driver-update']
              });
            }

      - name: 💬 Post Update Summary
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:chore/monthly-update-${context.runId}`,
              sort: 'updated',
              direction: 'desc'
            });
            
            const pr = prs[0];
            
            if (pr) {
              console.log(`PR created: ${pr.html_url}`);
              console.log(`::notice title=PR Created::${pr.html_url}`);
            } else {
              console.log('No PR was created.');
            }
