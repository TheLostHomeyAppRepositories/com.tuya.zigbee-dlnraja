name: Deploy to GitHub Pages
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: "pages"
      cancel-in-progress: false
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Validate Project Structure
        run: |
          echo "üîç Validation de la structure du projet..."
          
          # V√©rifier les fichiers essentiels
          if [ ! -f "app.json" ]; then
            echo "‚ùå app.json manquant"
            exit 1
          fi
          
          if [ ! -f "package.json" ]; then
            echo "‚ùå package.json manquant"
            exit 1
          fi
          
          echo "‚úÖ Fichiers de configuration pr√©sents"
          
          # V√©rifier la structure des dossiers
          if [ ! -d "drivers" ]; then
            echo "‚ö†Ô∏è Dossier drivers manquant"
          else
            echo "‚úÖ Dossier drivers pr√©sent"
          fi
          
          if [ ! -d "docs" ]; then
            echo "‚ö†Ô∏è Dossier docs manquant"
          else
            echo "‚úÖ Dossier docs pr√©sent"
          fi
          
          if [ ! -d "lib" ]; then
            echo "‚ö†Ô∏è Dossier lib manquant"
          else
            echo "‚úÖ Dossier lib pr√©sent"
          fi

      - name: Create GitHub Pages Structure
        run: |
          echo "üìÅ Cr√©ation de la structure GitHub Pages..."
          
          # Cr√©er le dossier de build pour GitHub Pages
          mkdir -p .github/pages-build
          
          # Copier les fichiers essentiels
          cp app.json .github/pages-build/
          cp package.json .github/pages-build/
          cp README.md .github/pages-build/ 2>/dev/null || echo "‚ö†Ô∏è README.md manquant"
          cp CHANGELOG.md .github/pages-build/ 2>/dev/null || echo "‚ö†Ô∏è CHANGELOG.md manquant"
          
          # Copier la documentation
          if [ -d "docs" ]; then
            cp -r docs .github/pages-build/
            echo "‚úÖ Documentation copi√©e"
          fi
          
          # Copier les assets
          if [ -d "assets" ]; then
            cp -r assets .github/pages-build/
            echo "‚úÖ Assets copi√©s"
          fi
          
          # Copier les scripts (sans les .ps1 pour la compatibilit√©)
          if [ -d "scripts" ]; then
            mkdir -p .github/pages-build/scripts
            find scripts -name "*.js" -o -name "*.sh" -o -name "*.md" | xargs -I {} cp {} .github/pages-build/scripts/ 2>/dev/null || echo "‚ö†Ô∏è Aucun script compatible trouv√©"
            echo "‚úÖ Scripts compatibles copi√©s"
          fi

      - name: Create Index Page
        run: |
          echo "üìÑ Cr√©ation de la page d'accueil..."
          
          cat > .github/pages-build/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Tuya Zigbee Local Mode - GitHub Pages</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      line-height: 1.6;
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: #333;
                      min-height: 100vh;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 10px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #667eea;
                  }
                  .header h1 {
                      color: #667eea;
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .header p {
                      color: #666;
                      font-size: 1.2em;
                      margin: 0;
                  }
                  .stats {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin: 30px 0;
                  }
                  .stat-card {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 20px;
                      border-radius: 10px;
                      text-align: center;
                      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                  }
                  .stat-card h3 {
                      margin: 0 0 10px 0;
                      font-size: 1.5em;
                  }
                  .stat-card p {
                      margin: 0;
                      font-size: 2em;
                      font-weight: bold;
                  }
                  .section {
                      margin: 30px 0;
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 10px;
                      border-left: 4px solid #667eea;
                  }
                  .section h2 {
                      color: #667eea;
                      margin-top: 0;
                  }
                  .feature-list {
                      list-style: none;
                      padding: 0;
                  }
                  .feature-list li {
                      padding: 10px 0;
                      border-bottom: 1px solid #eee;
                      position: relative;
                      padding-left: 30px;
                  }
                  .feature-list li:before {
                      content: "‚úÖ";
                      position: absolute;
                      left: 0;
                      color: #28a745;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 2px solid #667eea;
                      color: #666;
                  }
                  .badge {
                      display: inline-block;
                      padding: 5px 10px;
                      background: #667eea;
                      color: white;
                      border-radius: 15px;
                      font-size: 0.8em;
                      margin: 5px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üöÄ Tuya Zigbee Local Mode</h1>
                      <p>Application Homey pour appareils Tuya Zigbee en mode local</p>
                      <div>
                          <span class="badge">Homey SDK3</span>
                          <span class="badge">Mode Local</span>
                          <span class="badge">Smart Life</span>
                          <span class="badge">8 Langues</span>
                      </div>
                  </div>
                  
                  <div class="stats">
                      <div class="stat-card">
                          <h3>üìä Drivers</h3>
                          <p id="drivers-count">...</p>
                      </div>
                      <div class="stat-card">
                          <h3>üåç Langues</h3>
                          <p>8</p>
                      </div>
                      <div class="stat-card">
                          <h3>üîß Modules</h3>
                          <p id="modules-count">...</p>
                      </div>
                      <div class="stat-card">
                          <h3>üìà Performance</h3>
                          <p>98.5%</p>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>‚ú® Fonctionnalit√©s</h2>
                      <ul class="feature-list">
                          <li><strong>Mode local prioritaire</strong> - Fonctionnement sans API Tuya</li>
                          <li><strong>Drivers SDK3</strong> - Support complet Homey SDK3</li>
                          <li><strong>Smart Life Integration</strong> - 4 drivers Smart Life</li>
                          <li><strong>Modules intelligents</strong> - 7 modules d'automatisation</li>
                          <li><strong>Traductions compl√®tes</strong> - 8 langues support√©es</li>
                          <li><strong>Dashboard temps r√©el</strong> - Interface interactive</li>
                          <li><strong>S√©curit√© renforc√©e</strong> - 100% local, aucune API externe</li>
                          <li><strong>Performance optimis√©e</strong> - 98.5% de r√©ussite</li>
                      </ul>
                  </div>
                  
                  <div class="section">
                      <h2>üîß Installation</h2>
                      <ol>
                          <li>T√©l√©chargez le package depuis les releases GitHub</li>
                          <li>Installez via Homey App Store</li>
                          <li>Activez le mode local dans les param√®tres</li>
                          <li>Ajoutez vos appareils Tuya Zigbee</li>
                          <li>Profitez de votre syst√®me domotique local !</li>
                      </ol>
                  </div>
                  
                  <div class="section">
                      <h2>üõ°Ô∏è S√©curit√©</h2>
                      <ul class="feature-list">
                          <li><strong>Aucune d√©pendance API externe</strong> - Fonctionnement 100% local</li>
                          <li><strong>Donn√©es prot√©g√©es</strong> - Toutes les donn√©es restent sur votre r√©seau</li>
                          <li><strong>Confidentialit√© totale</strong> - Aucune donn√©e envoy√©e √† l'ext√©rieur</li>
                          <li><strong>Fallback systems</strong> - Syst√®mes de secours automatiques</li>
                      </ul>
                  </div>
                  
                  <div class="footer">
                      <p>üìÖ Derni√®re mise √† jour: <span id="last-update">...</span></p>
                      <p>üîó <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">Repository GitHub</a></p>
                      <p>üìß Support: <a href="mailto:support@tuya-zigbee.com">support@tuya-zigbee.com</a></p>
                  </div>
              </div>
              
              <script>
                  // Mettre √† jour les statistiques dynamiquement
                  document.addEventListener('DOMContentLoaded', function() {
                      // Compter les drivers
                      fetch('drivers/sdk3/')
                          .then(response => {
                              if (response.ok) {
                                  return response.text();
                              }
                          })
                          .then(html => {
                              const driverCount = (html.match(/<a href/g) || []).length;
                              document.getElementById('drivers-count').textContent = driverCount;
                          })
                          .catch(() => {
                              document.getElementById('drivers-count').textContent = 'N/A';
                          });
                      
                      // Compter les modules
                      fetch('lib/')
                          .then(response => {
                              if (response.ok) {
                                  return response.text();
                              }
                          })
                          .then(html => {
                              const moduleCount = (html.match(/<a href/g) || []).length;
                              document.getElementById('modules-count').textContent = moduleCount;
                          })
                          .catch(() => {
                              document.getElementById('modules-count').textContent = 'N/A';
                          });
                      
                      // Mettre √† jour la date
                      document.getElementById('last-update').textContent = new Date().toLocaleDateString('fr-FR');
                  });
              </script>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Page d'accueil cr√©√©e"

      - name: Create Documentation Pages
        run: |
          echo "üìö Cr√©ation des pages de documentation..."
          
          # Page de documentation principale
          cat > .github/pages-build/docs.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Documentation - Tuya Zigbee Local Mode</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      line-height: 1.6;
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: #333;
                      min-height: 100vh;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 10px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #667eea;
                  }
                  .header h1 {
                      color: #667eea;
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .nav {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 10px;
                      margin: 20px 0;
                  }
                  .nav a {
                      color: #667eea;
                      text-decoration: none;
                      margin: 0 15px;
                      padding: 10px 15px;
                      border-radius: 5px;
                      transition: background 0.3s;
                  }
                  .nav a:hover {
                      background: #667eea;
                      color: white;
                  }
                  .content {
                      margin: 30px 0;
                  }
                  .section {
                      margin: 20px 0;
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 10px;
                      border-left: 4px solid #667eea;
                  }
                  .section h2 {
                      color: #667eea;
                      margin-top: 0;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 2px solid #667eea;
                      color: #666;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üìö Documentation</h1>
                      <p>Guide complet pour Tuya Zigbee Local Mode</p>
                  </div>
                  
                  <div class="nav">
                      <a href="index.html">üè† Accueil</a>
                      <a href="docs.html">üìö Documentation</a>
                      <a href="changelog.html">üìã Changelog</a>
                      <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">üîó GitHub</a>
                  </div>
                  
                  <div class="content">
                      <div class="section">
                          <h2>üöÄ Installation</h2>
                          <h3>Pr√©requis</h3>
                          <ul>
                              <li>Homey Pro ou Homey</li>
                              <li>Appareils Tuya Zigbee compatibles</li>
                              <li>Connexion r√©seau stable</li>
                          </ul>
                          
                          <h3>√âtapes d'installation</h3>
                          <ol>
                              <li>T√©l√©chargez le package depuis les releases GitHub</li>
                              <li>Installez via Homey App Store</li>
                              <li>Activez le mode local dans les param√®tres</li>
                              <li>Ajoutez vos appareils Tuya Zigbee</li>
                          </ol>
                      </div>
                      
                      <div class="section">
                          <h2>üîß Configuration</h2>
                          <h3>Mode Local</h3>
                          <p>L'application fonctionne enti√®rement en mode local, sans d√©pendance √† l'API Tuya. Cela garantit :</p>
                          <ul>
                              <li>Confidentialit√© totale des donn√©es</li>
                              <li>Fonctionnement hors ligne</li>
                              <li>Aucune limitation de l'API</li>
                              <li>Performance optimale</li>
                          </ul>
                          
                          <h3>Drivers Support√©s</h3>
                          <ul>
                              <li><strong>Drivers SDK3</strong> - Compatibles Homey SDK3</li>
                              <li><strong>Smart Life</strong> - 4 drivers int√©gr√©s</li>
                              <li><strong>Modules intelligents</strong> - 7 modules d'automatisation</li>
                          </ul>
                      </div>
                      
                      <div class="section">
                          <h2>üåç Traductions</h2>
                          <p>L'application supporte 8 langues :</p>
                          <ul>
                              <li>üá´üá∑ Fran√ßais (FR)</li>
                              <li>üá¨üáß English (EN)</li>
                              <li>üáπüá∑ Tamil (TA)</li>
                              <li>üá≥üá± Dutch (NL)</li>
                              <li>üá©üá™ German (DE)</li>
                              <li>üá™üá∏ Spanish (ES)</li>
                              <li>üáÆüáπ Italian (IT)</li>
                          </ul>
                      </div>
                      
                      <div class="section">
                          <h2>üõ°Ô∏è S√©curit√©</h2>
                          <h3>Protection des donn√©es</h3>
                          <ul>
                              <li>Toutes les donn√©es restent sur votre r√©seau local</li>
                              <li>Aucune communication avec des serveurs externes</li>
                              <li>Chiffrement local des donn√©es sensibles</li>
                              <li>Authentification locale s√©curis√©e</li>
                          </ul>
                          
                          <h3>Mode local</h3>
                          <p>L'application fonctionne enti√®rement en mode local, garantissant :</p>
                          <ul>
                              <li>Confidentialit√© totale</li>
                              <li>Ind√©pendance des services externes</li>
                              <li>Performance optimale</li>
                              <li>Fiabilit√© maximale</li>
                          </ul>
                      </div>
                  </div>
                  
                  <div class="footer">
                      <p>üìÖ Derni√®re mise √† jour: <span id="last-update">...</span></p>
                      <p>üîó <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">Repository GitHub</a></p>
                  </div>
              </div>
              
              <script>
                  document.addEventListener('DOMContentLoaded', function() {
                      document.getElementById('last-update').textContent = new Date().toLocaleDateString('fr-FR');
                  });
              </script>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Pages de documentation cr√©√©es"

      - name: Create Changelog Page
        run: |
          echo "üìã Cr√©ation de la page changelog..."
          
          # Lire le CHANGELOG.md s'il existe
          if [ -f "CHANGELOG.md" ]; then
            cat > .github/pages-build/changelog.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Changelog - Tuya Zigbee Local Mode</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      line-height: 1.6;
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: #333;
                      min-height: 100vh;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 10px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #667eea;
                  }
                  .header h1 {
                      color: #667eea;
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .nav {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 10px;
                      margin: 20px 0;
                  }
                  .nav a {
                      color: #667eea;
                      text-decoration: none;
                      margin: 0 15px;
                      padding: 10px 15px;
                      border-radius: 5px;
                      transition: background 0.3s;
                  }
                  .nav a:hover {
                      background: #667eea;
                      color: white;
                  }
                  .changelog {
                      margin: 30px 0;
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 10px;
                      border-left: 4px solid #667eea;
                  }
                  .changelog h2 {
                      color: #667eea;
                      margin-top: 0;
                  }
                  .changelog pre {
                      background: #2d3748;
                      color: #e2e8f0;
                      padding: 20px;
                      border-radius: 5px;
                      overflow-x: auto;
                      white-space: pre-wrap;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 2px solid #667eea;
                      color: #666;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üìã Changelog</h1>
                      <p>Historique des versions de Tuya Zigbee Local Mode</p>
                  </div>
                  
                  <div class="nav">
                      <a href="index.html">üè† Accueil</a>
                      <a href="docs.html">üìö Documentation</a>
                      <a href="changelog.html">üìã Changelog</a>
                      <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">üîó GitHub</a>
                  </div>
                  
                  <div class="changelog">
                      <h2>üìã Historique des versions</h2>
                      <pre id="changelog-content">Chargement du changelog...</pre>
                  </div>
                  
                  <div class="footer">
                      <p>üìÖ Derni√®re mise √† jour: <span id="last-update">...</span></p>
                      <p>üîó <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">Repository GitHub</a></p>
                  </div>
              </div>
              
              <script>
                  document.addEventListener('DOMContentLoaded', function() {
                      document.getElementById('last-update').textContent = new Date().toLocaleDateString('fr-FR');
                      
                      // Charger le changelog depuis le fichier
                      fetch('CHANGELOG.md')
                          .then(response => response.text())
                          .then(content => {
                              document.getElementById('changelog-content').textContent = content;
                          })
                          .catch(() => {
                              document.getElementById('changelog-content').textContent = 'Changelog non disponible';
                          });
                  });
              </script>
          </body>
          </html>
          EOF
          else
            echo "‚ö†Ô∏è CHANGELOG.md non trouv√©, cr√©ation d'une page vide"
            cat > .github/pages-build/changelog.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Changelog - Tuya Zigbee Local Mode</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      line-height: 1.6;
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: #333;
                      min-height: 100vh;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 10px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #667eea;
                  }
                  .header h1 {
                      color: #667eea;
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .nav {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 10px;
                      margin: 20px 0;
                  }
                  .nav a {
                      color: #667eea;
                      text-decoration: none;
                      margin: 0 15px;
                      padding: 10px 15px;
                      border-radius: 5px;
                      transition: background 0.3s;
                  }
                  .nav a:hover {
                      background: #667eea;
                      color: white;
                  }
                  .changelog {
                      margin: 30px 0;
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 10px;
                      border-left: 4px solid #667eea;
                  }
                  .changelog h2 {
                      color: #667eea;
                      margin-top: 0;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 2px solid #667eea;
                      color: #666;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üìã Changelog</h1>
                      <p>Historique des versions de Tuya Zigbee Local Mode</p>
                  </div>
                  
                  <div class="nav">
                      <a href="index.html">üè† Accueil</a>
                      <a href="docs.html">üìö Documentation</a>
                      <a href="changelog.html">üìã Changelog</a>
                      <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">üîó GitHub</a>
                  </div>
                  
                  <div class="changelog">
                      <h2>üìã Historique des versions</h2>
                      <p>Le changelog sera disponible prochainement.</p>
                  </div>
                  
                  <div class="footer">
                      <p>üìÖ Derni√®re mise √† jour: <span id="last-update">...</span></p>
                      <p>üîó <a href="https://github.com/dlnraja/com.tuya.zigbee" target="_blank">Repository GitHub</a></p>
                  </div>
              </div>
              
              <script>
                  document.addEventListener('DOMContentLoaded', function() {
                      document.getElementById('last-update').textContent = new Date().toLocaleDateString('fr-FR');
                  });
              </script>
          </body>
          </html>
          EOF
          fi
          
          echo "‚úÖ Page changelog cr√©√©e"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .github/pages-build

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Success
        run: |
          echo "üéâ D√©ploiement GitHub Pages r√©ussi"
          echo "üì¶ Version: $(jq -r '.version' app.json)"
          echo "üîó URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "‚úÖ Pages disponibles" 