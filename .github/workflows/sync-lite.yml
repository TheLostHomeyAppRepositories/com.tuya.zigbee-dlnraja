name: 🔄 Sync to Lite Repository

on:
  schedule:
    - cron: '0 6 1 * *' # First day of each month at 6 AM UTC
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes'
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout main repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: |
        npm ci
        
    - name: 🔍 Analyze current state
      run: |
        npm run analyze:lite-compatibility
        echo "Lite compatibility analysis completed"
        
    - name: 📊 Generate Lite drivers list
      run: |
        npm run generate:lite-drivers
        echo "Lite drivers list generated"
        
    - name: 🔍 Validate Lite drivers
      run: |
        npm run validate:lite-drivers
        echo "Lite drivers validation completed"
        
    - name: 📝 Prepare Lite repository
      run: |
        npm run prepare:lite-repo
        echo "Lite repository preparation completed"
        
    - name: 📤 Upload Lite artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lite-artifacts
        path: |
          lite-repo/
          reports/lite/
          drivers/lite/
        retention-days: 30

  create-lite-pr:
    runs-on: ubuntu-latest
    needs: sync
    if: success()
    
    steps:
    - name: 📥 Checkout lite repository
      uses: actions/checkout@v4
      with:
        ref: dlnraja/tuya-light
        token: ${{ secrets.LITE_REPO_TOKEN }}
        path: lite-repo
        
    - name: 📥 Download Lite artifacts
      uses: actions/download-artifact@v4
      with:
        name: lite-artifacts
        path: ./
        
    - name: 🔍 Check for changes
      id: check-changes
      run: |
        cd lite-repo
        if git diff --quiet HEAD~1 HEAD; then
          echo "no-changes=true" >> $GITHUB_OUTPUT
        else
          echo "no-changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: 📝 Create Lite Pull Request
      if: steps.check-changes.outputs.no-changes == 'false' || ${{ github.event.inputs.force_sync }}
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.LITE_REPO_TOKEN }}
        repository: dlnraja/tuya-light
        commit-message: |
          🔄 Monthly sync from main repository
          
          Automated sync from Universal Tuya Zigbee main repository:
          - Lite-compatible drivers only
          - No AI features or advanced diagnostics
          - Core functionality maintained
          - Performance optimized
          
          Changes:
          - Updated driver list
          - Synchronized capabilities
          - Updated documentation
          - Optimized assets
          
          Generated by GitHub Actions sync workflow
          Date: ${{ github.event.schedule || 'Manual trigger' }}
        title: |
          🔄 Monthly Sync: Lite drivers update
        body: |
          ## 🔄 Monthly Lite Repository Sync
          
          This PR contains the monthly synchronization from the main Universal Tuya Zigbee repository.
          
          ### 📊 Summary of Changes
          - **Drivers Synced**: [Count] lite-compatible drivers
          - **Capabilities Updated**: [Count] capabilities synchronized
          - **Documentation**: README and metadata updated
          - **Assets**: Optimized for lite usage
          
          ### 🔍 Lite Compatibility
          - **AI Features**: ❌ Disabled
          - **Advanced Diagnostics**: ❌ Disabled
          - **Heuristic Inference**: ❌ Disabled
          - **Core Functionality**: ✅ Maintained
          - **Performance**: ✅ Optimized
          
          ### 📋 Review Checklist
          - [ ] Only lite-compatible drivers included
          - [ ] No AI or advanced features
          - [ ] Core capabilities work properly
          - [ ] Documentation is lite-appropriate
          - [ ] Assets are optimized
          
          ### 🧪 Testing
          - [ ] Drivers load without errors
          - [ ] Basic capabilities work
          - [ ] No AI dependencies
          - [ ] Performance is acceptable
          
          ### 📈 Impact
          - **Sync Score**: [Score] / 100
          - **Lite Compliance**: [Level] (low/medium/high)
          - **Performance**: [Level] (low/medium/high)
          
          ---
          
          *Generated by GitHub Actions on ${{ github.event.schedule || 'Manual trigger' }}*
          
          **Note**: This is a monthly automated sync. Please review for lite compliance.
        branch: monthly-sync/${{ github.run_id }}
        base: main
        delete-branch: true
        labels: |
          auto-generated
          monthly-sync
          lite-repository
          drivers
        assignees: dlnraja
        reviewers: dlnraja
        
    - name: 📊 Update Lite metrics
      if: steps.check-changes.outputs.no-changes == 'false' || ${{ github.event.inputs.force_sync }}
      run: |
        npm run update:lite-metrics
        echo "Lite metrics updated"
        
    - name: 📤 Upload sync artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sync-artifacts
        path: |
          reports/lite/
          drivers/lite/
          lite-repo/
        retention-days: 90

  notification:
    runs-on: ubuntu-latest
    needs: [sync, create-lite-pr]
    if: always()
    
    steps:
    - name: 📧 Send notification
      run: |
        echo "## 🔄 Lite Sync Notification" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.create-lite-pr.outputs.no-changes }}" == "false" ] || [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
          echo "✅ Lite sync completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "📝 Pull Request created in lite repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No changes detected - no PR created" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "📊 Lite artifacts uploaded" >> $GITHUB_STEP_SUMMARY
        echo "🔄 Next scheduled sync: First day of next month at 6 AM UTC" >> $GITHUB_STEP_SUMMARY
        
    - name: 📧 Send Discord notification
      if: ${{ needs.create-lite-pr.outputs.no-changes == 'false' || github.event.inputs.force_sync }}
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        status: ${{ job.status }}
        title: "Lite Repository Synced"
        description: |
          **Universal Tuya Zigbee Lite** repository synchronized!
          
          🔄 Monthly sync completed successfully
          📱 Lite-compatible drivers updated
          🔗 [View on GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        color: "00ff00"

  cleanup:
    runs-on: ubuntu-latest
    needs: [sync, create-lite-pr, notification]
    if: always()
    
    steps:
    - name: 🧹 Cleanup temporary files
      run: |
        npm run cleanup:lite-temp
        echo "Lite temporary files cleaned up"
        
    - name: 📊 Update sync metrics
      run: |
        npm run update:sync-metrics
        echo "Sync metrics updated"
        
    - name: 📤 Upload final artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: final-sync-artifacts
        path: |
          reports/
          logs/
          metrics/
        retention-days: 365
