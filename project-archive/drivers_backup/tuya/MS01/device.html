<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuya Multi-Sensor Settings</title>
    <script type="text/javascript" src="https://unpkg.com/@homey/apps-sdk-v3@^3.0.0/dist/Homey.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@homey/apps-sdk-v3@^3.0.0/dist/Homey.css">
    <style>
        /* Custom styles that work within Homey's design system */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        
        .sensor-card {
            background: var(--homey-card-bg);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sensor-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--homey-color-primary);
        }
        
        .sensor-value {
            font-size: 20px;
            font-weight: 600;
            margin: 4px 0;
        }
        
        .sensor-label {
            font-size: 12px;
            color: var(--homey-color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card {
            margin-bottom: 16px;
            background: var(--homey-card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 12px 16px;
            background: var(--homey-color-primary);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .card-body {
            padding: 16px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .hint {
            font-size: 12px;
            color: var(--homey-color-text-secondary);
            margin-top: 4px;
            font-style: italic;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: right;
            font-weight: 500;
        }
        
        /* Status indicators */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-online {
            background-color: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }
        
        .status-offline {
            background-color: rgba(189, 195, 199, 0.3);
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="loading" class="homey-loading">
            <homey-loading></homey-loading>
        </div>
        
        <div v-else>
            <!-- Status Tab -->
            <div v-if="activeTab === 'status'" class="tab-content">
                <div class="sensor-grid">
                    <div class="sensor-card">
                        <div class="sensor-icon">
                            <homey-icon icon="fas fa-thermometer-half"></homey-icon>
                        </div>
                        <div class="sensor-value">{{ temperature }}Â°{{ temperatureUnit === 'fahrenheit' ? 'F' : 'C' }}</div>
                        <div class="sensor-label">{{ $t('sensor.temperature') }}</div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-icon">
                            <homey-icon icon="fas fa-tint"></homey-icon>
                        </div>
                        <div class="sensor-value">{{ humidity }}%</div>
                        <div class="sensor-label">{{ $t('sensor.humidity') }}</div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-icon">
                            <homey-icon :icon="batteryIcon"></homey-icon>
                        </div>
                        <div class="sensor-value">{{ battery }}%</div>
                        <div class="sensor-label">{{ $t('sensor.battery') }}</div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-icon">
                            <homey-icon icon="fas fa-running"></homey-icon>
                        </div>
                        <div class="sensor-value">{{ motion ? $t('motion.detected') : $t('motion.none') }}</div>
                        <div class="sensor-label">{{ $t('sensor.motion') }}</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <homey-icon icon="fas fa-info-circle" class="homey-icon--left"></homey-icon>
                        {{ $t('status.deviceStatus') }}
                        <span class="status-badge status-online" style="margin-left: auto;">
                            {{ $t('status.online') }}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>{{ $t('status.lastUpdate') }}</label>
                            <div class="hint">{{ lastUpdated }}</div>
                        </div>
                        <div class="form-group">
                            <label>{{ $t('status.signalStrength') }}</label>
                            <div class="hint">
                                <homey-progress-bar :value="signalStrength" :show-value="true"></homey-progress-bar>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div v-else-if="activeTab === 'settings'" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <homey-icon icon="fas fa-sliders-h" class="homey-icon--left"></homey-icon>
                        {{ $t('settings.general') }}
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <homey-form-input
                                :title="$t('settings.deviceName')"
                                type="text"
                                v-model="settings.deviceName"
                            ></homey-form-input>
                        </div>
                        
                        <div class="form-group">
                            <label>{{ $t('settings.reportInterval') }}</label>
                            <homey-slider
                                v-model="settings.reportInterval"
                                :min="60"
                                :max="43200"
                                :step="60"
                                :suffix="formatSeconds(settings.reportInterval)"
                            ></homey-slider>
                            <div class="hint">{{ $t('settings.reportIntervalHint') }}</div>
                        </div>
                        
                        <div class="form-group">
                            <homey-form-checkbox
                                :title="$t('settings.ledEnabled')"
                                v-model="settings.ledEnabled"
                            ></homey-form-checkbox>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <homey-icon icon="fas fa-battery-three-quarters" class="homey-icon--left"></homey-icon>
                        {{ $t('settings.battery' }}
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>{{ $t('settings.lowBatteryThreshold') }}</label>
                            <homey-slider
                                v-model="settings.batteryThreshold"
                                :min="5"
                                :max="50"
                                :step="1"
                                suffix="%"
                            ></homey-slider>
                            <div class="hint">{{ $t('settings.batteryThresholdHint') }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="save-container">
                    <homey-button @click="saveSettings" :loading="saving">
                        {{ $t('common.save') }}
                    </homey-button>
                </div>
            </div>
            
            <!-- Advanced Tab -->
            <div v-else-if="activeTab === 'advanced'" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <homey-icon icon="fas fa-tools" class="homey-icon--left"></homey-icon>
                        {{ $t('advanced.deviceInfo') }}
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>{{ $t('advanced.firmwareVersion') }}</label>
                            <div class="hint">{{ deviceInfo.firmware || 'v1.0.0' }}</div>
                        </div>
                        <div class="form-group">
                            <label>{{ $t('advanced.hardwareVersion') }}</label>
                            <div class="hint">{{ deviceInfo.hardware || '1.0' }}</div>
                        </div>
                        <div class="form-group">
                            <label>{{ $t('advanced.macAddress') }}</label>
                            <div class="hint">{{ deviceInfo.mac || '00:00:00:00:00:00' }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <homey-icon icon="fas fa-exclamation-triangle" class="homey-icon--left"></homey-icon>
                        {{ $t('advanced.dangerZone') }}
                    </div>
                    <div class="card-body">
                        <homey-button @click="confirmReboot" class="homey-button--secondary" fullwidth>
                            <homey-icon icon="fas fa-power-off" class="homey-icon--left"></homey-icon>
                            {{ $t('advanced.rebootDevice') }}
                        </homey-button>
                        
                        <homey-button @click="confirmReset" class="homey-button--danger" fullwidth style="margin-top: 8px;">
                            <homey-icon icon="fas fa-trash-alt" class="homey-icon--left"></homey-icon>
                            {{ $t('advanced.factoryReset') }}
                        </homey-button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="homey-tabbar">
                <div 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    class="homey-tabbar-item"
                    :class="{ 'active': activeTab === tab.id }"
                    @click="activeTab = tab.id"
                >
                    <homey-icon :icon="tab.icon"></homey-icon>
                    <div class="homey-tabbar-item-label">{{ tab.label }}</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { Homey, Vue } = window;
        
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: true,
                    activeTab: 'status',
                    saving: false,
                    tabs: [
                        { id: 'status', icon: 'fas fa-home', label: this.$t('tabs.status') },
                        { id: 'settings', icon: 'fas fa-cog', label: this.$t('tabs.settings') },
                        { id: 'advanced', icon: 'fas fa-tools', label: this.$t('tabs.advanced') }
                    ],
                    // Device state
                    temperature: 21.5,
                    humidity: 45,
                    battery: 87,
                    motion: false,
                    lastUpdated: new Date().toLocaleString(),
                    signalStrength: 85,
                    temperatureUnit: 'celsius',
                    // Settings
                    settings: {
                        deviceName: '',
                        reportInterval: 300,
                        ledEnabled: true,
                        batteryThreshold: 20,
                        motionSensitivity: 'medium',
                        temperatureOffset: 0,
                        humidityOffset: 0
                    },
                    deviceInfo: {}
                };
            },
            computed: {
                batteryIcon() {
                    if (this.battery > 75) return 'fas fa-battery-full';
                    if (this.battery > 50) return 'fas fa-battery-three-quarters';
                    if (this.battery > 25) return 'fas fa-battery-half';
                    if (this.battery > 10) return 'fas fa-battery-quarter';
                    return 'fas fa-battery-empty';
                }
            },
            async created() {
                try {
                    // Initialize Homey
                    await Homey.ready();
                    
                    // Load device settings
                    await this.loadSettings();
                    
                    // Start polling for updates
                    this.startPolling();
                    
                    this.loading = false;
                } catch (err) {
                    console.error('Error initializing device settings:', err);
                    Homey.alert(this.$t('errors.initializationError'));
                }
            },
            methods: {
                async loadSettings() {
                    try {
                        const settings = await Homey.getSettings();
                        if (settings) {
                            this.settings = { ...this.settings, ...settings };
                        }
                        
                        // Load device info
                        this.deviceInfo = await Homey.getDeviceInfo();
                        
                        // Set device name if not set
                        if (!this.settings.deviceName && this.deviceInfo.name) {
                            this.settings.deviceName = this.deviceInfo.name;
                        }
                    } catch (err) {
                        console.error('Error loading settings:', err);
                        Homey.alert(this.$t('errors.loadSettingsError'));
                    }
                },
                
                async saveSettings() {
                    this.saving = true;
                    try {
                        await Homey.setSettings(this.settings);
                        Homey.alert(this.$t('settings.savedSuccessfully'), 'success');
                    } catch (err) {
                        console.error('Error saving settings:', err);
                        Homey.alert(this.$t('errors.saveSettingsError'));
                    } finally {
                        this.saving = false;
                    }
                },
                
                startPolling() {
                    // Update sensor values periodically
                    this.updateSensorValues();
                    this.pollingInterval = setInterval(this.updateSensorValues, 30000); // Every 30 seconds
                },
                
                async updateSensorValues() {
                    try {
                        const data = await Homey.getDeviceState();
                        if (data) {
                            this.temperature = data.temperature || this.temperature;
                            this.humidity = data.humidity || this.humidity;
                            this.battery = data.battery || this.battery;
                            this.motion = data.motion || false;
                            this.signalStrength = data.signalStrength || this.signalStrength;
                            this.lastUpdated = new Date().toLocaleString();
                        }
                    } catch (err) {
                        console.error('Error updating sensor values:', err);
                    }
                },
                
                formatSeconds(seconds) {
                    if (seconds < 60) return `${seconds}s`;
                    if (seconds < 3600) return `${Math.round(seconds / 60)} min`;
                    return `${(seconds / 3600).toFixed(1)} h`;
                },
                
                async confirmReboot() {
                    const confirmed = await Homey.confirm(
                        this.$t('advanced.confirmRebootTitle'),
                        this.$t('advanced.confirmRebootMessage')
                    );
                    
                    if (confirmed) {
                        try {
                            await Homey.rebootDevice();
                            Homey.alert(this.$t('advanced.rebooting'), 'info');
                        } catch (err) {
                            console.error('Error rebooting device:', err);
                            Homey.alert(this.$t('errors.rebootError'));
                        }
                    }
                },
                
                async confirmReset() {
                    const confirmed = await Homey.confirm(
                        this.$t('advanced.confirmResetTitle'),
                        this.$t('advanced.confirmResetMessage'),
                        { isDangerous: true }
                    );
                    
                    if (confirmed) {
                        try {
                            await Homey.factoryResetDevice();
                            Homey.alert(this.$t('advanced.resetting'), 'info');
                            // Redirect to device list after reset
                            setTimeout(() => {
                                Homey.close();
                            }, 2000);
                        } catch (err) {
                            console.error('Error resetting device:', err);
                            Homey.alert(this.$t('errors.resetError'));
                        }
                    }
                }
            },
            beforeDestroy() {
                // Clean up polling
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
            }
        });
    </script>
</body>
</html>
